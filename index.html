<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Marketing Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        
        .sidebar {
            background-color: #162447;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .sidebar.show {
            transform: translateX(0);
        }
        
        .sidebar .nav-link {
            color: #e0e0e0;
            border-radius: 0.5rem;
            margin-bottom: 0.25rem;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: #1f4068;
            color: #fff;
        }
        
        .sidebar .nav-link i {
            width: 24px;
            margin-right: 12px;
        }
        
        .main-content {
            background-color: #1f4068;
            min-height: 100vh;
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }
        
        .card {
            background-color: #1b1b3a;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: #162447;
            border-bottom: 1px solid #333;
        }
        
        .btn-primary {
            background-color: #1f4068;
            border-color: #1f4068;
        }
        
        .btn-primary:hover {
            background-color: #162447;
            border-color: #162447;
        }
        
        .btn-danger {
            background-color: #e43f5a;
            border-color: #e43f5a;
        }
        
        .btn-danger:hover {
            background-color: #b43048;
            border-color: #b43048;
        }
        
        .modal-content {
            background-color: #1a1a2e;
            border: 1px solid #333;
        }
        
        .modal-header {
            border-bottom: 1px solid #333;
        }
        
        .form-control {
            background-color: #333;
            border: 1px solid #555;
            color: #e0e0e0;
        }
        
        .form-control:focus {
            background-color: #333;
            border-color: #1f4068;
            color: #e0e0e0;
            box-shadow: 0 0 0 0.2rem rgba(31, 64, 104, 0.25);
        }
        
        .table {
            color: #e0e0e0;
        }
        
        .table thead th {
            border-color: #333;
            background-color: #162447;
        }
        
        .table tbody tr {
            border-color: #333;
        }
        
        .table tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1055;
        }
        
        .toast {
            background-color: #1b1b3a;
            border: 1px solid #333;
            color: #e0e0e0;
        }
        
        .toast.bg-success {
            background-color: #28a745 !important;
        }
        
        .toast.bg-danger {
            background-color: #dc3545 !important;
        }
        
        .navbar-toggler {
            border: none;
            color: #e0e0e0;
        }
        
        .navbar-toggler:focus {
            box-shadow: none;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.show {
            display: block;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1b1b3a 0%, #162447 100%);
            border: none;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .account-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #1f4068 0%, #e43f5a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .validation-result {
            background-color: #0d1117;
            border: 1px solid #333;
        }
        
        @media (min-width: 992px) {
            .sidebar {
                position: relative;
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
        
        @media (max-width: 576px) {
            .stat-number {
                font-size: 1.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Overlay -->
    <div class="overlay" id="sidebarOverlay"></div>
    
    <!-- Top Navigation for Mobile -->
    <nav class="navbar navbar-expand-lg d-lg-none" style="background-color: #162447;">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 text-white">TeleBot Dash</span>
            <button class="navbar-toggler" type="button" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-lg-3 col-xl-2 sidebar p-0" id="sidebar">
                <div class="p-4">
                    <div class="text-center mb-4 d-none d-lg-block">
                        <h2 class="h3 text-white fw-bold">TeleBot Dash</h2>
                    </div>
                    
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-section="dashboard">
                                <i class="fas fa-tachometer-alt"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="campaigns">
                                <i class="fas fa-bullhorn"></i>Campaigns
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="accounts">
                                <i class="fas fa-users"></i>Accounts
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="customer-finder">
                                <i class="fas fa-search-dollar"></i>Customer Finder
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="management">
                                <i class="fas fa-tasks"></i>Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="targeting">
                                <i class="fas fa-crosshairs"></i>Targeting
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="link-validator">
                                <i class="fas fa-link"></i>Link Validator
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-auto pt-4">
                        <ul class="nav nav-pills flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="settings">
                                    <i class="fas fa-cog"></i>Settings
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-lg-9 col-xl-10 main-content">
                <div class="p-3 p-md-4">
                    <!-- Dashboard Section -->
                    <section id="dashboard">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="display-6 fw-bold">Dashboard</h1>
                        </div>
                        
                        <div class="row g-3 g-md-4 mb-5">
                            <div class="col-6 col-lg-3">
                                <div class="card stat-card h-100">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Active Campaigns</h5>
                                        <p class="display-4 stat-number fw-bold mb-0" id="stats-campaigns">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-lg-3">
                                <div class="card stat-card h-100">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Accounts Linked</h5>
                                        <p class="display-4 stat-number fw-bold mb-0" id="stats-accounts">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-lg-3">
                                <div class="card stat-card h-100">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Customers Found</h5>
                                        <p class="display-4 stat-number fw-bold mb-0" id="stats-customers">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-lg-3">
                                <div class="card stat-card h-100">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Messages Sent</h5>
                                        <p class="display-4 stat-number fw-bold mb-0" id="stats-messages">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Campaigns Section -->
                    <section id="campaigns" class="d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="display-6 fw-bold">Automated Campaigns</h1>
                            <button id="createCampaignBtn" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Create Campaign
                            </button>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Status</th>
                                                <th>Sent</th>
                                                <th>Replies</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="campaigns-table-body">
                                            <!-- Campaigns will be dynamically inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Accounts Section -->
                    <section id="accounts" class="d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="display-6 fw-bold">Multi-Account Mastery</h1>
                            <button id="addAccountBtn" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Add Account
                            </button>
                        </div>
                        
                        <div class="row g-3 g-md-4" id="accounts-grid">
                            <!-- Accounts will be dynamically inserted here -->
                        </div>
                    </section>

                    <!-- Customer Finder Section -->
                    <section id="customer-finder" class="d-none">
                        <h1 class="display-6 fw-bold mb-4">Smart Customer Finder</h1>
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Smart Replies & Forwards</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <p class="mb-0">Enable smart replies to automatically engage potential customers.</p>
                                    <button id="toggle-smart-replies" class="btn btn-primary">Enable</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Management Section -->
                    <section id="management" class="d-none">
                        <h1 class="display-6 fw-bold mb-4">Streamlined Management</h1>
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Manage Groups & Channels</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-0">Bulk add/remove members, post announcements, and manage topics.</p>
                            </div>
                        </div>
                    </section>

                    <!-- Targeting Section -->
                    <section id="targeting" class="d-none">
                        <h1 class="display-6 fw-bold mb-4">Precision Targeting</h1>
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Filter & Extract Audience</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-0">Define criteria to extract a targeted list of users for your campaigns.</p>
                            </div>
                        </div>
                    </section>

                    <!-- Link Validator Section -->
                    <section id="link-validator" class="d-none">
                        <h1 class="display-6 fw-bold mb-4">Link Validator</h1>
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Telegram Link to Validate</h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3 mb-4">
                                    <div class="col-12 col-md-8">
                                        <input type="text" id="link-to-validate" class="form-control" placeholder="e.g., t.me/AdBitOfficial">
                                    </div>
                                    <div class="col-12 col-md-4">
                                        <button id="validate-link-btn" class="btn btn-primary w-100">Validate Link</button>
                                    </div>
                                </div>
                                
                                <div class="validation-result rounded p-3 mb-3">
                                    <h6 class="fw-bold mb-2">Validation Result:</h6>
                                    <p class="mb-1"><span class="fw-bold">Status:</span> <span id="validation-status">Pending...</span></p>
                                    <p class="mb-0"><span class="fw-bold">Last Checked:</span> <span id="validation-last-checked">N/A</span></p>
                                </div>
                                
                                <div class="small text-muted">
                                    <p class="mb-1"><span class="fw-bold text-success">Example Valid:</span> t.me/AdBitOfficial - Active (Public Channel)</p>
                                    <p class="mb-0"><span class="fw-bold text-danger">Example Invalid:</span> t.me/expired_group_link - Not Found (404)</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Settings Section -->
                    <section id="settings" class="d-none">
                        <h1 class="display-6 fw-bold mb-4">Settings</h1>
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Security</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-0">Manage your account security, including two-factor authentication.</p>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div class="modal fade" id="addAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Account</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="addAccountForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="accountName" class="form-label">Account Name (e.g., @username)</label>
                            <input type="text" id="accountName" class="form-control" required>
                        </div>
                        <p class="small text-muted">In a real application, you would upload your Telegram session file here to securely add an account.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Campaign Modal -->
    <div class="modal fade" id="createCampaignModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create a New Campaign</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="createCampaignForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="campaignName" class="form-label">Campaign Name</label>
                            <input type="text" id="campaignName" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="campaignMessage" class="form-label">Message</label>
                            <textarea id="campaignMessage" class="form-control" rows="4" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Launch Campaign</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container">
        <div id="toast" class="toast" role="alert">
            <div class="toast-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, deleteDoc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIza...",
                authDomain: "your-project-id.firebaseapp.com",
                projectId: "your-project-id",
                storageBucket: "your-project-id.appspot.com",
                messagingSenderId: "...",
                appId: "..."
            };

        let app, auth, db, userId;
        let addAccountModal, createCampaignModal, toastElement;

        // Initialize Bootstrap components
        document.addEventListener('DOMContentLoaded', function() {
            addAccountModal = new bootstrap.Modal(document.getElementById('addAccountModal'));
            createCampaignModal = new bootstrap.Modal(document.getElementById('createCampaignModal'));
            toastElement = new bootstrap.Toast(document.getElementById('toast'));
        });

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        loadInitialData();
                    } else {
                        userId = null;
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showToast("Firebase not configured correctly. App is in read-only mode.", "danger");
            }
        }
        
        initializeFirebase();

        // Mobile sidebar toggle
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        sidebarToggle?.addEventListener('click', function() {
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        });

        overlay.addEventListener('click', function() {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        });

        // Navigation
        const sections = document.querySelectorAll('main section');
        const navLinks = document.querySelectorAll('.nav-link[data-section]');

        navLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                const sectionId = link.getAttribute('data-section');
                
                // Update active nav link
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                // Show/hide sections
                sections.forEach(section => {
                    section.classList.toggle('d-none', section.id !== sectionId);
                });

                // Close mobile sidebar
                if (window.innerWidth < 992) {
                    sidebar.classList.remove('show');
                    overlay.classList.remove('show');
                }
            });
        });

        function loadInitialData() {
            if (!userId) return;
            loadAccounts();
            loadCampaigns();
            loadStats();
        }

        function loadStats() {
            const statsDocRef = doc(db, "users", userId, "stats", "summary");
            onSnapshot(statsDocRef, (doc) => {
                const data = doc.data() || { campaigns: 0, accounts: 0, customers: 0, messages: 0 };
                document.getElementById('stats-campaigns').textContent = data.campaigns;
                document.getElementById('stats-accounts').textContent = data.accounts;
                document.getElementById('stats-customers').textContent = data.customers;
                document.getElementById('stats-messages').textContent = data.messages;
            });
        }

        function loadAccounts() {
            const accountsColRef = collection(db, "users", userId, "accounts");
            onSnapshot(accountsColRef, (snapshot) => {
                const accountsGrid = document.getElementById('accounts-grid');
                accountsGrid.innerHTML = '';
                snapshot.forEach(doc => {
                    const account = doc.data();
                    const accountCard = document.createElement('div');
                    accountCard.className = 'col-12 col-md-6 col-lg-4';
                    accountCard.innerHTML = `
                        <div class="card h-100">
                            <div class="card-body d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <div class="account-avatar rounded-circle me-3">
                                        ${account.name.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fw-bold">${account.name}</h6>
                                        <small class="text-success">Active</small>
                                    </div>
                                </div>
                                <button data-id="${doc.id}" class="delete-account-btn btn btn-outline-danger btn-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>`;
                    accountsGrid.appendChild(accountCard);
                });
            });
        }
        
        function loadCampaigns() {
            const campaignsColRef = collection(db, "users", userId, "campaigns");
            onSnapshot(campaignsColRef, (snapshot) => {
                const campaignsBody = document.getElementById('campaigns-table-body');
                campaignsBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const campaign = doc.data();
                    const campaignRow = document.createElement('tr');
                    campaignRow.innerHTML = `
                        <td>${campaign.name}</td>
                        <td><span class="badge bg-success">Active</span></td>
                        <td>${campaign.sent || 0}</td>
                        <td>${campaign.replies || 0}</td>
                        <td>
                            <button data-id="${doc.id}" class="delete-campaign-btn btn btn-outline-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>`;
                    campaignsBody.appendChild(campaignRow);
                });
            });
        }

        // Form handlers
        document.getElementById('addAccountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const accountName = document.getElementById('accountName').value;
            if (!accountName.trim()) return;

            try {
                await addDoc(collection(db, `users/${userId}/accounts`), {
                    name: accountName,
                    status: 'active',
                    createdAt: serverTimestamp()
                });
                await updateStats('accounts', 1);
                showToast('Account added successfully!', 'success');
                addAccountModal.hide();
                e.target.reset();
            } catch (err) {
                showToast('Failed to add account.', 'danger');
                console.error(err);
            }
        });

        document.getElementById('createCampaignForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const campaignName = document.getElementById('campaignName').value;
            const campaignMessage = document.getElementById('campaignMessage').value;
            if(!campaignName.trim() || !campaignMessage.trim()) return;

            try {
                await addDoc(collection(db, `users/${userId}/campaigns`), {
                    name: campaignName,
                    message: campaignMessage,
                    status: 'active',
                    sent: 0,
                    replies: 0,
                    createdAt: serverTimestamp()
                });
                await updateStats('campaigns', 1);
                showToast('Campaign created successfully!', 'success');
                createCampaignModal.hide();
                e.target.reset();
            } catch(err) {
                showToast('Failed to create campaign.', 'danger');
                console.error(err);
            }
        });

        // Link validator
        document.getElementById('validate-link-btn').addEventListener('click', () => {
            const linkInput = document.getElementById('link-to-validate');
            const statusEl = document.getElementById('validation-status');
            const lastCheckedEl = document.getElementById('validation-last-checked');
            const link = linkInput.value.trim();

            if (!link || !link.toLowerCase().includes('t.me/')) {
                showToast('Please enter a valid Telegram link (e.g., t.me/username)', 'danger');
                return;
            }

            statusEl.textContent = 'Validating...';
            statusEl.className = 'text-warning';
            lastCheckedEl.textContent = 'N/A';

            setTimeout(() => {
                const isValid = Math.random() > 0.4; // 60% chance of being valid
                if (isValid) {
                    statusEl.textContent = 'Active (Public Channel/Group)';
                    statusEl.className = 'text-success';
                } else {
                    statusEl.textContent = 'Not Found (404) or Private';
                    statusEl.className = 'text-danger';
                }
                lastCheckedEl.textContent = new Date().toLocaleString();
            }, 1500);
        });

        // Button event handlers
        document.getElementById('addAccountBtn').addEventListener('click', () => {
            addAccountModal.show();
        });

        document.getElementById('createCampaignBtn').addEventListener('click', () => {
            createCampaignModal.show();
        });

        // Delete handlers using event delegation
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-account-btn') || e.target.closest('.delete-account-btn')) {
                const btn = e.target.classList.contains('delete-account-btn') ? e.target : e.target.closest('.delete-account-btn');
                const docId = btn.dataset.id;
                if (confirm('Are you sure you want to delete this account?')) {
                    try {
                        await deleteDoc(doc(db, `users/${userId}/accounts`, docId));
                        await updateStats('accounts', -1);
                        showToast('Account deleted.', 'success');
                    } catch (err) {
                        showToast('Error deleting account.', 'danger');
                    }
                }
            }
            
            if (e.target.classList.contains('delete-campaign-btn') || e.target.closest('.delete-campaign-btn')) {
                const btn = e.target.classList.contains('delete-campaign-btn') ? e.target : e.target.closest('.delete-campaign-btn');
                const docId = btn.dataset.id;
                if (confirm('Are you sure you want to delete this campaign?')) {
                    try {
                        await deleteDoc(doc(db, `users/${userId}/campaigns`, docId));
                        await updateStats('campaigns', -1);
                        showToast('Campaign deleted.', 'success');
                    } catch (err) {
                        showToast('Error deleting campaign.', 'danger');
                    }
                }
            }
        });

        async function updateStats(field, increment) {
            const statsDocRef = doc(db, "users", userId, "stats", "summary");
            try {
                await runTransaction(db, async (transaction) => {
                    const statsDoc = await transaction.get(statsDocRef);
                    if (!statsDoc.exists()) {
                        transaction.set(statsDocRef, { [field]: increment });
                    } else {
                        const newCount = (statsDoc.data()[field] || 0) + increment;
                        transaction.update(statsDocRef, { [field]: newCount < 0 ? 0 : newCount });
                    }
                });
            } catch (e) {
                console.error("Transaction failed: ", e);
            }
        }

        function showToast(message, type = 'success') {
            const toastBody = document.querySelector('#toast .toast-body');
            const toastEl = document.getElementById('toast');
            
            toastBody.textContent = message;
            toastEl.className = `toast bg-${type}`;
            
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // Smart replies toggle
        document.getElementById('toggle-smart-replies').addEventListener('click', function() {
            const btn = this;
            const isEnabled = btn.textContent === 'Disable';
            
            if (isEnabled) {
                btn.textContent = 'Enable';
                btn.className = 'btn btn-primary';
                showToast('Smart replies disabled', 'warning');
            } else {
                btn.textContent = 'Disable';
                btn.className = 'btn btn-success';
                showToast('Smart replies enabled', 'success');
            }
        });

        // Handle window resize for sidebar
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 992) {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
            }
        });

    </script>
</body>
</html>
                
